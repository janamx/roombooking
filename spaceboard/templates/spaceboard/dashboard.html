{% extends "base.html" %}

{% block content %}

    <h1>Hier findest du deine Buchungen:</h1>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <div id='calendar' style="max-width: 900px; margin: 40px auto; height: 600px;"></div>

    <div id="event-info"
        style="display: none; position: absolute; background: #f9f9f9; border: 1px solid #ccc; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 1000;">
        <input type="hidden" id="booking-id">
        <strong>Raum: <span id="room-name"></span></strong><br>
        <span>Start: <span id="start-time"></span></span><br>
        <span>Ende: <span id="end-time"></span></span>
        <div style="display: inline-block; margin-right: 10px;">
            <a href="{% url 'spaceboard:dashboard' %}" class="outlined close-link">Schließen</a>
        </div>
        <div style="display: inline-block; margin-right: 10px;">
            <a href="{% url 'spaceboard:dashboard' %}" class="outlined edit-link">Bearbeiten</a>
        </div>
        <div style="display: inline-block; margin-right: 10px;">
            <a href="#" class="outlined delete-link">Löschen</a>
        </div>
        
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                events: '{% url "spaceboard:bookings-api" %}?user={{ request.user.id }}',
                headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay',
                },
                height: 569,
                nowIndicator: true,
                locale: 'de',
                businessHours: {
                    daysOfWeek: [ 1, 2, 3, 4, 5 ]
                },
                weekends: false,
                slotMinTime: "08:00",
                slotMaxTime: "18:00",
                allDaySlot: false,
                selectable: true,
                eventClick: function(info) {
                    const id = info.event.id;
                    const room = info.event.extendedProps.room;
                    const start = info.event.start.toLocaleString();
                    const end = info.event.end ? info.event.end.toLocaleString() : 'Offen';

                    document.querySelector('.close-link').addEventListener('click', function () {
                        document.getElementById('event-info').style.display = 'none';
                    });

                    document.getElementById('booking-id').value = id;
                    document.getElementById('room-name').textContent = room;
                    document.getElementById('start-time').textContent = start;
                    document.getElementById('end-time').textContent = end;

                    const box = document.getElementById('event-info');
                    box.style.left = info.jsEvent.pageX + 'px';
                    box.style.top = info.jsEvent.pageY + 'px';
                    box.style.display = 'block';

                    info.jsEvent.preventDefault();

                    document.querySelector('#event-info .edit-link').href = `/spaceboard/dashboard/edit/${id}/`;
                    document.querySelector('#event-info .delete-link').href = `/spaceboard/dashboard/delete/${id}/`;
                }
            });
            calendar.render();
        });
    </script>

    {% if request.user.is_superuser %}
        <center><a href="http://127.0.0.1:8000/admin/" class="outlined">Zur Admin-Seite</a></center>
    {% endif %}
    
{% endblock %}